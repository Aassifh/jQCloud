/*!
 * jQCloud 2.0.0
 * Copyright 2011 Luca Ongaro (http://www.lucaongaro.eu)
 * Copyright 2013 Daniel White (http://www.developerdan.com)
 * Copyright 2014 Damien "Mistic" Sorel (http://www.strangeplanet.fr)
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 */
!function(a){"use strict";var b=function(b,c,d){this.$element=a(b),this.word_array=c||[],this.options=d,this.timeouts={},this.namespace,this.already_placed_words=[],this.step,this.aspect_ratio,this.max_weight,this.min_weight,this.initialize()};b.prototype={initialize:function(){this.options.width&&this.$element.width(this.options.width),this.options.height&&this.$element.height(this.options.height);var b={width:this.options.width||this.$element.width(),height:this.options.height||this.$element.height(),delay:this.word_array.length>50?10:0,shape:"elliptic",encodeURI:!0,removeOverflowing:!0,afterCloudRender:null};b.center={x:b.width/2,y:b.height/2},this.options=a.extend(!0,b,this.options),this.step="rectangular"===this.options.shape?18:2,this.aspect_ratio=this.options.width/this.options.height,this.clearTimeouts(),this.namespace=(this.$element.attr("id")||Math.floor(1e6*Math.random()).toString(36))+"_word_",this.$element.addClass("jqcloud"),"static"===this.$element.css("position")&&this.$element.css("position","relative"),this.createTimeout(a.proxy(this.drawWordCloud,this),10)},overlapping:function(a,b){return Math.abs(2*a.left+a.width-2*b.left-b.width)<a.width+b.width&&Math.abs(2*a.top+a.height-2*b.top-b.height)<a.height+b.height?!0:!1},createTimeout:function(b,c){var d=setTimeout(a.proxy(function(){delete this.timeouts[d],b()},this),c);this.timeouts[d]=!0},clearTimeouts:function(){a.each(this.timeouts,function(a){clearTimeout(a)}),this.timeouts={}},hitTest:function(a){for(var b=0,c=this.already_placed_words.length;c>b;b++)if(this.overlapping(a,this.already_placed_words[b]))return!0;return!1},drawWordCloud:function(){for(var a=0,b=this.word_array.length;b>a;a++)this.word_array[a].weight=parseFloat(this.word_array[a].weight,10);if(this.word_array.sort(function(a,b){return b.weight-a.weight}),this.word_array.length>0&&(this.max_weight=this.word_array[0].weight,this.min_weight=this.word_array[this.word_array.length-1].weight),this.options.delay>0)this.drawOneWordDelayed();else{for(var a=0,b=this.word_array.length;b>a;a++)this.drawOneWord(a,this.word_array[a]);"function"==typeof this.options.afterCloudRender&&this.options.afterCloudRender.call(this.$element)}},drawOneWord:function(b,c){var d,e,f,g=this.namespace+b,h=6.28*Math.random(),i=0,j=0,k=0,l=5,m="";for(c.html=a.extend(c.html||{},{id:g}),this.max_weight!=this.min_weight&&(l=Math.round(9*(c.weight-this.min_weight)/(this.max_weight-this.min_weight))+1),d=a("<span>").attr(c.html).addClass("w"+l),c.link?("string"==typeof c.link&&(c.link={href:c.link}),this.options.encodeURI&&(c.link.href=encodeURI(c.link.href).replace(/'/g,"%27")),m=a("<a>").attr(c.link).text(c.text)):m=c.text,d.append(m),c.handlers&&a.each(c.handlers,function(b,c){"function"==typeof c&&a(d).on(b,c)}),this.$element.append(d),e={width:d.width(),height:d.height()},e.left=this.options.center.x-e.width/2,e.top=this.options.center.y-e.height/2,f=d[0].style,f.position="absolute",f.left=e.left+"px",f.top=e.top+"px";this.hitTest(e);){if("rectangular"===this.options.shape)switch(j++,j*this.step>(1+Math.floor(k/2))*this.step*(k%4%2===0?1:this.aspect_ratio)&&(j=0,k++),k%4){case 1:e.left+=this.step*this.aspect_ratio+2*Math.random();break;case 2:e.top-=this.step+2*Math.random();break;case 3:e.left-=this.step*this.aspect_ratio+2*Math.random();break;case 0:e.top+=this.step+2*Math.random()}else i+=this.step,h+=(b%2===0?1:-1)*this.step,e.left=this.options.center.x-e.width/2+i*Math.cos(h)*this.aspect_ratio,e.top=this.options.center.y+i*Math.sin(h)-e.height/2;f.left=e.left+"px",f.top=e.top+"px"}return this.options.removeOverflowing&&(e.left<0||e.top<0||e.left+e.width>this.options.width||e.top+e.height>this.options.height)?void d.remove():(this.already_placed_words.push(e),void("function"==typeof c.afterWordRender&&c.afterWordRender.call(d)))},drawOneWordDelayed:function(b){return b=b||0,this.$element.is(":visible")?void(b<this.word_array.length?(this.drawOneWord(b,this.word_array[b]),this.createTimeout(a.proxy(function(){this.drawOneWordDelayed(b+1)},this),this.options.delay)):"function"==typeof this.options.afterCloudRender&&this.options.afterCloudRender.call(this.$element)):void this.createTimeout(a.proxy(function(){this.drawOneWordDelayed(b)},this),this.options.delay)},destroy:function(){this.clearTimeouts(),this.$element.removeClass("jqcloud"),this.$element.removeData("jqcloud"),this.$element.children('[id^="'+this.namespace+'"]').remove()},update:function(a){this.$element.children('[id^="'+this.namespace+'"]').remove(),this.word_array=a,this.already_placed_words=[],this.clearTimeouts(),this.drawWordCloud()}},a.fn.jQCloud=function(c,d){var e=arguments;return this.each(function(){var f=a(this),g=f.data("jqcloud");if(g)"string"==typeof c&&g[c].apply(g,Array.prototype.slice.call(e,1));else{var h="object"==typeof d?d:{};f.data("jqcloud",g=new b(this,c,h))}})}}(jQuery);