/*!
 * jQCloud 2.0.0
 * Copyright 2011 Luca Ongaro (http://www.lucaongaro.eu)
 * Copyright 2013 Daniel White (http://www.developerdan.com)
 * Copyright 2014 Damien "Mistic" Sorel (http://www.strangeplanet.fr)
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 */
!function(a){"use strict";var b=function(b,c,d){this.$element=a(b),this.word_array=c||[],this.options=d,this.timeouts,this.cloud_namespace,this.already_placed_words,this.step,this.aspect_ratio,this.initialize()};b.prototype={initialize:function(){var b={width:this.$element.width(),height:this.$element.height(),center:{x:(this.options&&this.options.width?this.options.width:this.$element.width())/2,y:(this.options&&this.options.height?this.options.height:this.$element.height())/2},delayedMode:this.word_array.length>50,shape:!1,encodeURI:!0,removeOverflowing:!0};return this.options=a.extend({},b,this.options),this.timeouts={},this.step="rectangular"===this.options.shape?18:2,this.aspect_ratio=this.options.width/this.options.height,this.already_placed_words=[],this.cloud_namespace=(this.$element.attr("id")||Math.floor(1e6*Math.random()).toString(36))+"_word_",this.$element.addClass("jqcloud").width(this.options.width).height(this.options.height),"static"===this.$element.css("position")&&this.$element.css("position","relative"),this.createTimeout(a.proxy(function(){this.drawWordCloud()},this),10),this.$element},overlapping:function(a,b){return Math.abs(2*a.left+a.width-2*b.left-b.width)<a.width+b.width&&Math.abs(2*a.top+a.height-2*b.top-b.height)<a.height+b.height?!0:!1},createTimeout:function(b,c){var d=setTimeout(a.proxy(function(){delete this.timeouts[d],b()},this),c);this.timeouts[d]=!0},clearTimeouts:function(){a.each(this.timeouts,function(a){clearTimeout(a)}),this.timeouts={}},hitTest:function(a){for(var b=0;b<this.already_placed_words.length;b++)if(this.overlapping(a,this.already_placed_words[b]))return!0;return!1},drawWordCloud:function(){for(var b=0;b<this.word_array.length;b++)this.word_array[b].weight=parseFloat(this.word_array[b].weight,10);this.word_array.sort(function(a,b){return a.weight<b.weight?1:a.weight>b.weight?-1:0}),this.options.delayedMode?this.drawOneWordDelayed():(a.each(this.word_array,a.proxy(this.drawOneWord,this)),a.isFunction(this.options.afterCloudRender)&&this.options.afterCloudRender.call(this.$element))},drawOneWord:function(b,c){var d,e=this.cloud_namespace+b,f=6.28*Math.random(),g=0,h=0,i=0,j=5,k="",l="";if(c.html=a.extend(c.html,{id:e}),c.html&&c.html["class"]&&(k=c.html["class"],delete c.html["class"]),this.word_array[0].weight>this.word_array[this.word_array.length-1].weight&&(j=Math.round((c.weight-this.word_array[this.word_array.length-1].weight)/(this.word_array[0].weight-this.word_array[this.word_array.length-1].weight)*9)+1),d=a("<span>").attr(c.html).addClass("w"+j+" "+k),c.link?("string"==typeof c.link&&(c.link={href:c.link}),this.options.encodeURI&&(c.link=a.extend(c.link,{href:encodeURI(c.link.href).replace(/'/g,"%27")})),l=a("<a>").attr(c.link).text(c.text)):l=c.text,d.append(l),c.handlers)for(var m in c.handlers)c.handlers.hasOwnProperty(m)&&"function"==typeof c.handlers[m]&&a(d).bind(m,c.handlers[m]);this.$element.append(d);var n={width:d.width(),height:d.height()};n.left=this.options.center.x-n.width/2,n.top=this.options.center.y-n.height/2;var o=d[0].style;for(o.position="absolute",o.left=n.left+"px",o.top=n.top+"px";this.hitTest(n);){if("rectangular"===this.options.shape)switch(h++,h*this.step>(1+Math.floor(i/2))*this.step*(i%4%2===0?1:this.aspect_ratio)&&(h=0,i++),i%4){case 1:n.left+=this.step*this.aspect_ratio+2*Math.random();break;case 2:n.top-=this.step+2*Math.random();break;case 3:n.left-=this.step*this.aspect_ratio+2*Math.random();break;case 0:n.top+=this.step+2*Math.random()}else g+=this.step,f+=(b%2===0?1:-1)*this.step,n.left=this.options.center.x-n.width/2+g*Math.cos(f)*this.aspect_ratio,n.top=this.options.center.y+g*Math.sin(f)-n.height/2;o.left=n.left+"px",o.top=n.top+"px"}return this.options.removeOverflowing&&(n.left<0||n.top<0||n.left+n.width>this.options.width||n.top+n.height>this.options.height)?void d.remove():(this.already_placed_words.push(n),void(a.isFunction(c.afterWordRender)&&c.afterWordRender.call(d)))},drawOneWordDelayed:function(b){return b=b||0,this.$element.is(":visible")?void(b<this.word_array.length?(this.drawOneWord(b,this.word_array[b]),this.createTimeout(a.proxy(function(){this.drawOneWordDelayed(b+1)},this),10)):a.isFunction(this.options.afterCloudRender)&&this.options.afterCloudRender.call(this.$element)):void this.createTimeout(a.proxy(function(){this.drawOneWordDelayed(b)},this),10)},destroy:function(){this.clearTimeouts(),this.$element.removeClass("jqcloud"),this.$element.removeData("jqcloud"),this.$element.children('[id^="'+this.cloud_namespace+'"]').remove()},update:function(a){this.$element.empty(),this.word_array=a,this.already_placed_words=[],this.clearTimeouts(),this.drawWordCloud()}},a.fn.jQCloud=function(c,d){var e=arguments,f="jqcloud";return this.each(function(){var g=a(this),h=g.data(f),i="object"==typeof d&&d;h||g.data(f,h=new b(this,c,i)),"string"==typeof c&&h[c].apply(h,Array.prototype.slice.call(e,1))})}}(jQuery);