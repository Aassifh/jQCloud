/*!
 * jQCloud Plugin for jQuery
 *
 * Version 1.0.4
 *
 * Copyright 2011, Luca Ongaro
 * Licensed under the MIT license.
 *
 * Date: 2013-11-13 20:30:34 -0500
*/
(function(e){"use strict";var t=function(t,n,r){this.$element=e(t);this.word_array=n||[];this.options=r;this.timeouts;this.cloud_namespace;this.already_placed_words;this.step;this.aspect_ratio;this.initialize()};t.prototype={initialize:function(){var t={width:this.$element.width(),height:this.$element.height(),center:{x:(this.options&&this.options.width?this.options.width:this.$element.width())/2,y:(this.options&&this.options.height?this.options.height:this.$element.height())/2},delayedMode:this.word_array.length>50,shape:false,encodeURI:true,removeOverflowing:true};this.options=e.extend({},t,this.options);this.timeouts={};this.step=this.options.shape==="rectangular"?18:2;this.aspect_ratio=this.options.width/this.options.height;this.already_placed_words=[];this.cloud_namespace=(this.$element.attr("id")||Math.floor(Math.random()*1e6).toString(36))+"_word_";this.$element.addClass("jqcloud").width(this.options.width).height(this.options.height);if(this.$element.css("position")==="static"){this.$element.css("position","relative")}this.createTimeout(e.proxy(function(){this.drawWordCloud()},this),10);return this.$element},overlapping:function(e,t){if(Math.abs(2*e.left+e.width-2*t.left-t.width)<e.width+t.width){if(Math.abs(2*e.top+e.height-2*t.top-t.height)<e.height+t.height){return true}}return false},createTimeout:function(t,n){var r=setTimeout(e.proxy(function(){delete this.timeouts[r];t()},this),n);this.timeouts[r]=true},hitTest:function(e){for(var t=0;t<this.already_placed_words.length;t++){if(this.overlapping(e,this.already_placed_words[t])){return true}}return false},drawWordCloud:function(){for(var t=0;t<this.word_array.length;t++){this.word_array[t].weight=parseFloat(this.word_array[t].weight,10)}this.word_array.sort(function(e,t){if(e.weight<t.weight)return 1;else if(e.weight>t.weight)return-1;else return 0});if(this.options.delayedMode){this.drawOneWordDelayed()}else{e.each(this.word_array,e.proxy(this.drawOneWord,this));if(e.isFunction(this.options.afterCloudRender)){this.options.afterCloudRender.call(this.$element)}}},drawOneWord:function(t,n){var r=this.cloud_namespace+t,i="#"+r,s=6.28*Math.random(),o=0,u=0,a=0,f=5,l="",c="",h;n.html=e.extend(n.html,{id:r});if(n.html&&n.html["class"]){l=n.html["class"];delete n.html["class"]}if(this.word_array[0].weight>this.word_array[this.word_array.length-1].weight){f=Math.round((n.weight-this.word_array[this.word_array.length-1].weight)/(this.word_array[0].weight-this.word_array[this.word_array.length-1].weight)*9)+1}h=e("<span>").attr(n.html).addClass("w"+f+" "+l);if(n.link){if(typeof n.link==="string"){n.link={href:n.link}}if(this.options.encodeURI){n.link=e.extend(n.link,{href:encodeURI(n.link.href).replace(/'/g,"%27")})}c=e("<a>").attr(n.link).text(n.text)}else{c=n.text}h.append(c);if(!!n.handlers){for(var p in n.handlers){if(n.handlers.hasOwnProperty(p)&&typeof n.handlers[p]==="function"){e(h).bind(p,n.handlers[p])}}}this.$element.append(h);var d={width:h.width(),height:h.height()};d.left=this.options.center.x-d.width/2;d.top=this.options.center.y-d.height/2;var v=h[0].style;v.position="absolute";v.left=d.left+"px";v.top=d.top+"px";while(this.hitTest(d)){if(this.options.shape==="rectangular"){u++;if(u*this.step>(1+Math.floor(a/2))*this.step*(a%4%2===0?1:this.aspect_ratio)){u=0;a++}switch(a%4){case 1:d.left+=this.step*this.aspect_ratio+Math.random()*2;break;case 2:d.top-=this.step+Math.random()*2;break;case 3:d.left-=this.step*this.aspect_ratio+Math.random()*2;break;case 0:d.top+=this.step+Math.random()*2;break}}else{o+=this.step;s+=(t%2===0?1:-1)*this.step;d.left=this.options.center.x-d.width/2+o*Math.cos(s)*this.aspect_ratio;d.top=this.options.center.y+o*Math.sin(s)-d.height/2}v.left=d.left+"px";v.top=d.top+"px"}if(this.options.removeOverflowing&&(d.left<0||d.top<0||d.left+d.width>this.options.width||d.top+d.height>this.options.height)){h.remove();return}this.already_placed_words.push(d);if(e.isFunction(n.afterWordRender)){n.afterWordRender.call(h)}},drawOneWordDelayed:function(t){var n;t=t||0;if(!this.$element.is(":visible")){this.createTimeout(e.proxy(function(){this.drawOneWordDelayed(t)},this),10);return}if(t<this.word_array.length){this.drawOneWord(t,this.word_array[t]);this.createTimeout(e.proxy(function(){this.drawOneWordDelayed(t+1)},this),10)}else{if(e.isFunction(this.options.afterCloudRender)){this.options.afterCloudRender.call(this.$element)}}},destroy:function(){e.each(this.timeouts,function(e){clearTimeout(e)});this.$element.removeClass("jqcloud");this.$element.removeData("jqcloud");this.$element.children('[id^="'+this.cloud_namespace+'"]').remove()},update:function(e){this.$element.empty();this.word_array=e;this.already_placed_words=[];this.drawWordCloud()}};e.fn.jQCloud=function(n,r){var i=arguments,s="jqcloud";return this.each(function(){var o=e(this),u=o.data(s),a=typeof r==="object"&&r;if(!u){o.data(s,u=new t(this,n,a))}if(typeof n==="string"){u[n].apply(u,Array.prototype.slice.call(i,1))}})}})(jQuery);